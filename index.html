<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkyDeal: Find the Best Flight Offers</title>
  <style>
    /* --- Minimal styling so modal + layout work everywhere --- */
    :root { --bg:#0f1623; --card:#182234; --muted:#263249; --txt:#e6eefc; --dim:#9fb1cc; --accent:#6aa6ff; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .container{max-width:1080px;margin:40px auto;padding:0 16px}
    h1{font-size:32px;margin:0 0 20px}
    .search-bar{background:var(--card);border-radius:14px;padding:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .field{background:var(--muted);border-radius:12px;padding:12px 14px;color:var(--txt);border:1px solid transparent;min-width:140px}
    .field input,.field select{background:transparent;border:0;color:var(--txt);width:100%;outline:none}
    .btn{background:#4d7cff;color:#fff;border:0;border-radius:12px;padding:10px 18px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:8px;background:var(--muted);border-radius:12px;padding:10px 14px;cursor:pointer;border:1px solid transparent}
    .results{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:18px}
    .panel{background:var(--card);border-radius:14px;padding:14px;min-height:200px}
    .panel h3{margin:0 0 10px}
    .empty{opacity:.75}
    .flight-card{background:var(--muted);border-radius:12px;padding:10px;margin:10px 0}
    .fc-title{font-weight:700}
    .fc-time{opacity:.85}
    .fc-price{font-weight:700;margin-top:4px}

    /* --- Payment Modal --- */
    .hidden{display:none !important}
    .pm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);z-index:50}
    .pm-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(820px,92vw);background:#111929;border:1px solid #243049;border-radius:14px;z-index:60;box-shadow:0 10px 40px rgba(0,0,0,.5)}
    .pm-header{padding:14px 16px;border-bottom:1px solid #243049}
    .pm-header h3{margin:0}
    .pm-tabs{display:flex;gap:8px;padding:12px 16px;border-bottom:1px solid #243049;flex-wrap:wrap}
    .pm-tab{background:#1a2335;border:1px solid #263249;border-radius:10px;color:#cfe0ff;padding:8px 12px;cursor:pointer}
    .pm-tab-active{background:#24324a;border-color:#44608a}
    .pm-body{max-height:46vh;overflow:auto;padding:4px 8px 12px}
    .pm-panel{list-style:none;margin:0;padding:8px}
    .pm-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px}
    .pm-item:hover{background:#1a2335}
    .pm-item input{transform:scale(1.2)}
    .pm-empty{opacity:.7;padding:12px}
    .pm-footer{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #243049}
    .pm-clear{background:#2a3751;border:1px solid #435a83;color:#d9e6ff;border-radius:10px;padding:8px 14px;cursor:pointer}
    .pm-done{background:#4d7cff;border:0;color:#fff;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer}

    /* small screens */
    @media (max-width:900px){ .results{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="container">
    <h1>SkyDeal: Find the Best Flight Offers</h1>

    <!-- Search Bar -->
    <div class="search-bar">
      <div class="field" style="width:110px">
        <input id="fromInput" placeholder="From (BOM)" maxlength="3" />
      </div>
      <div class="field" style="width:110px">
        <input id="toInput" placeholder="To (DEL)" maxlength="3" />
      </div>
      <div class="field">
        <input id="departDate" type="date" />
      </div>
      <div class="field">
        <input id="returnDate" type="date" />
      </div>
      <div class="field" style="width:90px">
        <select id="paxSelect">
          <option value="1" selected>1</option>
          <option value="2">2</option><option value="3">3</option><option value="4">4</option>
        </select>
      </div>
      <div class="field" style="width:140px">
        <select id="cabinSelect">
          <option>Economy</option>
          <option>Premium_Economy</option>
          <option>Business</option>
          <option>First</option>
        </select>
      </div>

      <!-- Trip type -->
      <label class="pill">
        <input id="tripOneWay" type="radio" name="trip" />
        One Way
      </label>
      <label class="pill">
        <input id="tripRound" type="radio" name="trip" checked />
        Round Trip
      </label>

      <!-- Payment Methods trigger -->
      <button id="paymentSelectBtn" class="pill" style="margin-left:auto">
        <span id="paymentSelectBtnLabel">Select Payment Methods</span>
      </button>

      <button id="searchBtn" class="btn">Search</button>
    </div>

    <!-- Results -->
    <div class="results">
      <div class="panel">
        <h3>Outbound Flights</h3>
        <div id="outboundList" class="empty">No flights</div>
      </div>
      <div class="panel">
        <h3>Return Flights</h3>
        <div id="returnList" class="empty">No flights</div>
      </div>
    </div>
  </div>

  <!-- Payment Modal / Overlay -->
  <div id="paymentOverlay" class="pm-overlay hidden"></div>

  <div id="paymentModal" class="pm-modal hidden" role="dialog" aria-modal="true" aria-labelledby="pmTitle">
    <div class="pm-header">
      <h3 id="pmTitle">Payment Methods</h3>
    </div>

    <div class="pm-tabs">
      <button type="button" data-pm-tab="creditCard"   class="pm-tab pm-tab-active">Credit Cards</button>
      <button type="button" data-pm-tab="debitCard"    class="pm-tab">Debit Cards</button>
      <button type="button" data-pm-tab="wallet"       class="pm-tab">Wallets</button>
      <button type="button" data-pm-tab="upi"          class="pm-tab">UPI</button>
      <button type="button" data-pm-tab="netBanking"   class="pm-tab">NetBanking</button>
      <button type="button" data-pm-tab="emi"          class="pm-tab">EMI</button>
    </div>

    <div class="pm-body">
      <ul data-pm-panel="creditCard"   id="pm-list-credit"      class="pm-panel"></ul>
      <ul data-pm-panel="debitCard"    id="pm-list-debit"       class="pm-panel hidden"></ul>
      <ul data-pm-panel="wallet"       id="pm-list-wallet"      class="pm-panel hidden"></ul>
      <ul data-pm-panel="upi"          id="pm-list-upi"         class="pm-panel hidden"></ul>
      <ul data-pm-panel="netBanking"   id="pm-list-netbanking"  class="pm-panel hidden"></ul>
      <ul data-pm-panel="emi"          id="pm-list-emi"         class="pm-panel hidden"></ul>
    </div>

    <div class="pm-footer">
      <button id="pmClearBtn" type="button" class="pm-clear">Clear</button>
      <button id="pmDoneBtn"  type="button" class="pm-done">Done</button>
    </div>
  </div>

  <!-- App logic -->
  <script>
  (function(){
    const BACKEND = 'https://skydeal-backend.onrender.com';
    const MARKUP_AMOUNT = 250; // (backend already applies; used for labeling)

    // Elements (matching your IDs)
    const $ = (id)=>document.getElementById(id);
    const els = {
      from: $('fromInput'),
      to: $('toInput'),
      depart: $('departDate'),
      ret: $('returnDate'),
      pax: $('paxSelect'),
      cabin: $('cabinSelect'),
      rOne: $('tripOneWay'),
      rRound: $('tripRound'),
      searchBtn: $('searchBtn'),

      outList: $('outboundList'),
      retList: $('returnList'),

      payBtn: $('paymentSelectBtn'),
      payBtnLabel: $('paymentSelectBtnLabel'),
      overlay: $('paymentOverlay'),
      modal: $('paymentModal'),
      tabs: Array.from(document.querySelectorAll('.pm-tab')),
      panels: {
        creditCard: $('pm-list-credit'),
        debitCard: $('pm-list-debit'),
        wallet: $('pm-list-wallet'),
        upi: $('pm-list-upi'),
        netBanking: $('pm-list-netbanking'),
        emi: $('pm-list-emi')
      },
      btnClear: $('pmClearBtn'),
      btnDone: $('pmDoneBtn')
    };

    // State
    let paymentOptions = { CreditCard:[], DebitCard:[], Wallet:[], UPI:[], NetBanking:[], EMI:[] };
    let selectedPayments = []; // [{bank, type}]
    let activeTab = 'creditCard';

    // Utils
    const toIata = v => (v||'').trim().toUpperCase().slice(0,3);
    const tripType = ()=> els.rRound?.checked ? 'round-trip' : 'one-way';
    const apiType = (key)=>({
      creditCard:'credit', debitCard:'debit',
      wallet:'wallet', upi:'upi',
      netBanking:'netbanking', emi:'emi'
    }[key] || null);

    function setBtnCount(){
      const n = selectedPayments.length;
      els.payBtnLabel.textContent = n ? `Payment Methods • ${n} selected` : 'Select Payment Methods';
    }

    function parseFirstJSON(text){
      const a = text.indexOf('{'), b = text.lastIndexOf('}');
      const slice = (a>=0 && b>=0) ? text.slice(a,b+1) : text;
      return JSON.parse(slice);
    }

    async function fetchJSON(url, opts={}){
      const res = await fetch(url, opts);
      const txt = await res.text();
      try { return parseFirstJSON(txt); }
      catch(e){ throw new Error(`Bad JSON from ${url}: ${txt.slice(0,200)}`); }
    }

    // Load payment options -> fill lists
    async function loadPaymentOptions(){
      try{
        const data = await fetchJSON(`${BACKEND}/payment-options`);
        const src = data?.options || {};
        const norm = { CreditCard:[], DebitCard:[], Wallet:[], UPI:[], NetBanking:[], EMI:[] };

        const mapKey = (k)=>{
          const s = (k||'').toLowerCase().replace(/\s+/g,'');
          if (s.includes('credit')) return 'CreditCard';
          if (s.includes('debit')) return 'DebitCard';
          if (s.includes('wallet')) return 'Wallet';
          if (s.includes('upi')) return 'UPI';
          if (s.includes('net')) return 'NetBanking';
          if (s.includes('emi')) return 'EMI';
          return null;
        };

        Object.keys(src).forEach(k=>{
          const bucket = mapKey(k);
          if (!bucket) return;
          const arr = Array.isArray(src[k]) ? src[k] : [];
          norm[bucket] = [...new Set(arr)].sort((a,b)=>a.localeCompare(b));
        });

        paymentOptions = norm;
        renderPaymentLists();
      }catch(e){
        console.error('payment-options failed:', e);
        renderPaymentLists(); // renders empty lists
      }
    }

    function renderPaymentLists(){
      const fill = (ul, banks, key)=>{
        ul.innerHTML = '';
        if (!banks || !banks.length){
          const li = document.createElement('li');
          li.className = 'pm-empty';
          li.textContent = 'No options available.';
          ul.appendChild(li);
          return;
        }
        banks.forEach(bank=>{
          const li = document.createElement('li');
          li.className = 'pm-item';
          const cb = document.createElement('input');
          cb.type = 'checkbox';
          cb.checked = selectedPayments.some(p => p.bank===bank && p.type===apiType(key));
          cb.addEventListener('change', ()=>{
            togglePayment(bank, key);
          });
          const label = document.createElement('span');
          label.textContent = bank;
          li.appendChild(cb);
          li.appendChild(label);
          ul.appendChild(li);
        });
      };
      fill(els.panels.creditCard,  paymentOptions.CreditCard,  'creditCard');
      fill(els.panels.debitCard,   paymentOptions.DebitCard,   'debitCard');
      fill(els.panels.wallet,      paymentOptions.Wallet,      'wallet');
      fill(els.panels.upi,         paymentOptions.UPI,         'upi');
      fill(els.panels.netBanking,  paymentOptions.NetBanking,  'netBanking');
      fill(els.panels.emi,         paymentOptions.EMI,         'emi');
      setBtnCount();
      showTab(activeTab);
    }

    function togglePayment(bank, key){
      const type = apiType(key);
      const i = selectedPayments.findIndex(p=>p.bank===bank && p.type===type);
      if (i>=0) selectedPayments.splice(i,1);
      else selectedPayments.push({ bank, type });
      setBtnCount();
    }

    function showTab(key){
      activeTab = key;
      els.tabs.forEach(btn=>{
        const k = btn.getAttribute('data-pm-tab');
        if (k===key) btn.classList.add('pm-tab-active');
        else btn.classList.remove('pm-tab-active');
      });
      Object.entries(els.panels).forEach(([k,ul])=>{
        if (k === ({
          creditCard:'creditCard', debitCard:'debitCard',
          wallet:'wallet', upi:'upi', netBanking:'netBanking', emi:'emi'
        }[k])){} // lint silencer
        ul.classList.toggle('hidden', k!==key);
      });
      // Ensure correct panel visibility (explicit)
      els.panels.creditCard.classList.toggle('hidden', key!=='creditCard');
      els.panels.debitCard.classList.toggle('hidden', key!=='debitCard');
      els.panels.wallet.classList.toggle('hidden', key!=='wallet');
      els.panels.upi.classList.toggle('hidden', key!=='upi');
      els.panels.netBanking.classList.toggle('hidden', key!=='netBanking');
      els.panels.emi.classList.toggle('hidden', key!=='emi');
    }

    // Modal open/close
    function openModal(){
      els.overlay.classList.remove('hidden');
      els.modal.classList.remove('hidden');
    }
    function closeModal(){
      els.overlay.classList.add('hidden');
      els.modal.classList.add('hidden');
    }

    // Render flight lists
    function renderFlights(items, mount){
      mount.innerHTML = '';
      if (!Array.isArray(items) || !items.length){
        mount.classList.add('empty');
        mount.textContent = 'No flights';
        return;
      }
      mount.classList.remove('empty');
      items.forEach(f=>{
        const portals = (f.portalPrices||[]).map(p=>{
          const price = p.finalPrice ?? p.basePrice ?? 0;
          const src = p.source || 'carrier+markup';
          return `<li><strong>${p.portal}</strong> — ₹${price} <small>(${src})</small></li>`;
        }).join('');
        const div = document.createElement('div');
        div.className = 'flight-card';
        div.innerHTML = `
          <div class="fc-title">${f.airlineName || ''} <span> ${f.flightNumber || ''}</span></div>
          <div class="fc-time">${f.departure || ''} → ${f.arrival || ''} • Stops: ${f.stops ?? 0}</div>
          <div class="fc-price">₹${f.price || ''}</div>
          <details><summary>Portal prices (+₹${MARKUP_AMOUNT} markup)</summary>
            <ul>${portals}</ul>
          </details>
        `;
        mount.appendChild(div);
      });
    }

    // Search
    async function doSearch(){
      const body = {
        from: toIata(els.from.value),
        to: toIata(els.to.value),
        departureDate: (els.depart.value||'').trim(),
        returnDate: tripType()==='round-trip' ? (els.ret.value||'').trim() : '',
        passengers: Number(els.pax.value || 1),
        travelClass: (els.cabin.value || 'Economy'),
        tripType: tripType(),
        paymentMethods: selectedPayments
      };
      if(!body.from || !body.to || !body.departureDate){
        alert('Please fill From, To and Departure Date.');
        return;
      }
      els.searchBtn.disabled = true;
      try{
        const res = await fetch(`${BACKEND}/search`, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const json = await res.json();
        renderFlights(json?.outboundFlights || [], els.outList);
        renderFlights(json?.returnFlights || [], els.retList);
      }catch(e){
        console.error('Search failed:', e);
        els.outList.textContent = 'Search failed.';
        els.retList.textContent = '';
      }finally{
        els.searchBtn.disabled = false;
      }
    }

    // Wire up
    els.payBtn?.addEventListener('click', openModal);
    els.overlay?.addEventListener('click', closeModal);
    els.btnClear?.addEventListener('click', ()=>{
      selectedPayments = [];
      setBtnCount();
      renderPaymentLists();
    });
    els.btnDone?.addEventListener('click', ()=>{
      setBtnCount();
      closeModal();
    });
    els.tabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const key = btn.getAttribute('data-pm-tab');
        showTab(key);
      });
    });
    els.rOne?.addEventListener('change', ()=>{
      // show/hide return field
      if (els.rOne.checked) els.ret.closest('.field').style.opacity = .45;
    });
    els.rRound?.addEventListener('change', ()=>{
      if (els.rRound.checked) els.ret.closest('.field').style.opacity = 1;
    });

    els.searchBtn?.addEventListener('click', doSearch);

    // Init
    loadPaymentOptions();
    setBtnCount();
    if (els.rOne?.checked) els.ret.closest('.field').style.opacity = .45;
  })();
  </script>
</body>
</html>
