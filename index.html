<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SkyDeal: Find the Best Flight Offers</title>
  <style>
    :root{--bg:#0f1623;--card:#182234;--muted:#263249;--txt:#e6eefc;--dim:#9fb1cc}
    *{box-sizing:border-box}html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1080px;margin:40px auto;padding:0 16px}
    h1{font-size:32px;margin:0 0 20px}
    .search-bar{background:#182234;border-radius:14px;padding:18px;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .field{background:#263249;border-radius:12px;padding:12px 14px;color:var(--txt);border:1px solid transparent;min-width:140px}
    .field input,.field select{background:transparent;border:0;color:var(--txt);width:100%;outline:none}
    .btn{background:#4d7cff;color:#fff;border:0;border-radius:12px;padding:10px 18px;font-weight:600;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#263249;border-radius:12px;padding:10px 14px;cursor:pointer;border:1px solid transparent}
    .results{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:18px}
    .panel{background:#182234;border-radius:14px;padding:14px;min-height:200px}
    .panel h3{margin:0 0 10px}
    .empty{opacity:.75}
    .flight-card{background:#263249;border-radius:12px;padding:10px;margin:10px 0}
    .fc-title{font-weight:700}
    .fc-time{opacity:.85}
    .fc-price{font-weight:700;margin-top:4px}
    .hidden{display:none!important}
    .pm-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);z-index:50}
    .pm-modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      width:min(820px,92vw);background:#111929;border:1px solid #243049;border-radius:14px;z-index:60;box-shadow:0 10px 40px rgba(0,0,0,.5)}
    .pm-header{padding:14px 16px;border-bottom:1px solid #243049}
    .pm-header h3{margin:0}
    .pm-tabs{display:flex;gap:8px;padding:12px 16px;border-bottom:1px solid #243049;flex-wrap:wrap}
    .pm-tab{background:#1a2335;border:1px solid #263249;border-radius:10px;color:#cfe0ff;padding:8px 12px;cursor:pointer}
    .pm-tab-active{background:#24324a;border-color:#44608a}
    .pm-body{max-height:46vh;overflow:auto;padding:4px 8px 12px}
    .pm-panel{list-style:none;margin:0;padding:8px}
    .pm-item{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px}
    .pm-item:hover{background:#1a2335}
    .pm-empty{opacity:.7;padding:12px}
    .pm-footer{display:flex;justify-content:flex-end;gap:8px;padding:12px 16px;border-top:1px solid #243049}
    .pm-clear{background:#2a3751;border:1px solid #435a83;color:#d9e6ff;border-radius:10px;padding:8px 14px;cursor:pointer}
    .pm-done{background:#4d7cff;border:0;color:#fff;border-radius:10px;padding:8px 14px;font-weight:700;cursor:pointer}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#2a3751;color:#cfe0ff;border:1px solid #435a83;padding:10px 14px;border-radius:10px;z-index:80}
    @media (max-width:900px){.results{grid-template-columns:1fr}}
  </style>
</head>
<body data-api="https://skydeal-backend.onrender.com">
  <div class="container">
    <h1>SkyDeal: Find the Best Flight Offers</h1>

    <div class="search-bar">
      <div class="field" style="width:110px"><input id="fromInput" placeholder="From (BOM)" maxlength="3"/></div>
      <div class="field" style="width:110px"><input id="toInput" placeholder="To (DEL)" maxlength="3"/></div>
      <div class="field"><input id="departDate" type="date"/></div>
      <div class="field"><input id="returnDate" type="date"/></div>
      <div class="field" style="width:90px">
        <select id="paxSelect"><option value="1" selected>1</option><option>2</option><option>3</option><option>4</option></select>
      </div>
      <div class="field" style="width:140px">
        <select id="cabinSelect">
          <option>Economy</option><option>Premium_Economy</option><option>Business</option><option>First</option>
        </select>
      </div>
      <label class="pill"><input id="tripOneWay" type="radio" name="trip"/> One Way</label>
      <label class="pill"><input id="tripRound" type="radio" name="trip" checked/> Round Trip</label>

      <button id="paymentSelectBtn" class="pill" style="margin-left:auto"><span id="paymentSelectBtnLabel">Select Payment Methods</span></button>
      <button id="searchBtn" class="btn">Search</button>
    </div>

    <div class="results">
      <div class="panel"><h3>Outbound Flights</h3><div id="outboundList" class="empty">No flights</div></div>
      <div class="panel"><h3>Return Flights</h3><div id="returnList" class="empty">No flights</div></div>
    </div>
  </div>

  <div id="paymentOverlay" class="pm-overlay hidden"></div>
  <div id="paymentModal" class="pm-modal hidden" role="dialog" aria-modal="true" aria-labelledby="pmTitle">
    <div class="pm-header"><h3 id="pmTitle">Payment Methods</h3></div>
    <div class="pm-tabs">
      <button type="button" data-pm-tab="CreditCard" class="pm-tab pm-tab-active">Credit Cards</button>
      <button type="button" data-pm-tab="DebitCard" class="pm-tab">Debit Cards</button>
      <button type="button" data-pm-tab="Wallet" class="pm-tab">Wallets</button>
      <button type="button" data-pm-tab="UPI" class="pm-tab">UPI</button>
      <button type="button" data-pm-tab="NetBanking" class="pm-tab">NetBanking</button>
      <button type="button" data-pm-tab="EMI" class="pm-tab">EMI</button>
    </div>
    <div class="pm-body">
      <ul data-pm-panel="CreditCard"   id="pm-list-credit" class="pm-panel"></ul>
      <ul data-pm-panel="DebitCard"    id="pm-list-debit"  class="pm-panel hidden"></ul>
      <ul data-pm-panel="Wallet"       id="pm-list-wallet" class="pm-panel hidden"></ul>
      <ul data-pm-panel="UPI"          id="pm-list-upi"    class="pm-panel hidden"></ul>
      <ul data-pm-panel="NetBanking"   id="pm-list-net"    class="pm-panel hidden"></ul>
      <ul data-pm-panel="EMI"          id="pm-list-emi"    class="pm-panel hidden"></ul>
    </div>
    <div class="pm-footer">
      <button id="pmClearBtn" type="button" class="pm-clear">Clear</button>
      <button id="pmDoneBtn"  type="button" class="pm-done">Done</button>
    </div>
  </div>

  <script>
  // ===== Config =====
  const API = document.body.dataset.api || 'https://skydeal-backend.onrender.com';
  const CARRIER_MARKUP = 250;

  // ===== Elements =====
  const els = {
    from: document.getElementById('fromInput'),
    to: document.getElementById('toInput'),
    dep: document.getElementById('departDate'),
    ret: document.getElementById('returnDate'),
    pax: document.getElementById('paxSelect'),
    cabin: document.getElementById('cabinSelect'),
    one: document.getElementById('tripOneWay'),
    rtrip: document.getElementById('tripRound'),
    search: document.getElementById('searchBtn'),
    outbound: document.getElementById('outboundList'),
    retlist: document.getElementById('returnList'),

    payBtn: document.getElementById('paymentSelectBtn'),
    payLabel: document.getElementById('paymentSelectBtnLabel'),
    overlay: document.getElementById('paymentOverlay'),
    modal: document.getElementById('paymentModal'),
    tabs: Array.from(document.querySelectorAll('.pm-tab')),
    panels: Array.from(document.querySelectorAll('.pm-panel')),
    pmClear: document.getElementById('pmClearBtn'),
    pmDone: document.getElementById('pmDoneBtn'),

    pmCredit: document.getElementById('pm-list-credit'),
    pmDebit: document.getElementById('pm-list-debit'),
    pmWallet: document.getElementById('pm-list-wallet'),
    pmUPI: document.getElementById('pm-list-upi'),
    pmNet: document.getElementById('pm-list-net'),
    pmEMI: document.getElementById('pm-list-emi'),
  };

  // ===== State =====
  let paymentOptions = null;      // from backend
  let selectedPayments = [];      // [{type:'CreditCard', value:'Hdfc Bank'}, ...]

  // ===== Helpers =====
  const toast = (msg) => {
    const t = document.createElement('div');
    t.className = 'toast';
    t.textContent = msg;
    document.body.appendChild(t);
    setTimeout(()=>{ t.remove(); }, 3500);
  };

  const fmtINR = (n) => new Intl.NumberFormat('en-IN').format(n);

  // Modal controls
  const openModal = () => { els.overlay.classList.remove('hidden'); els.modal.classList.remove('hidden'); };
  const closeModal = () => { els.overlay.classList.add('hidden'); els.modal.classList.add('hidden'); };

  const showTab = (key) => {
    els.tabs.forEach(b => b.classList.toggle('pm-tab-active', b.dataset.pmTab === key));
    els.panels.forEach(p => p.classList.toggle('hidden', p.getAttribute('data-pm-panel') !== key));
  };

  const setBtnCount = () => {
    const c = selectedPayments.length;
    els.payLabel.textContent = c ? \`\${c} selected\` : 'Select Payment Methods';
  };

  const renderList = (ul, arr, typeKey) => {
    ul.innerHTML = '';
    if (!arr || !arr.length) {
      const li = document.createElement('li');
      li.className = 'pm-empty';
      li.textContent = 'No options available.';
      ul.appendChild(li);
      return;
    }
    arr.forEach(v => {
      const li = document.createElement('li');
      li.className = 'pm-item';
      const id = \`\${typeKey}-\${v}\`.replace(/\\s+/g,'_');
      li.innerHTML = \`
        <input type="checkbox" id="\${id}">
        <label for="\${id}">\${v}</label>
      \`;
      const cb = li.querySelector('input');
      cb.checked = selectedPayments.some(p => p.type === typeKey && p.value === v);
      cb.addEventListener('change', () => {
        if (cb.checked) {
          selectedPayments.push({ type: typeKey, value: v });
        } else {
          selectedPayments = selectedPayments.filter(p => !(p.type === typeKey && p.value === v));
        }
        setBtnCount();
      });
      ul.appendChild(li);
    });
  };

  const renderPaymentLists = () => {
    if (!paymentOptions) return;
    renderList(els.pmCredit, paymentOptions.CreditCard, 'CreditCard');
    renderList(els.pmDebit,  paymentOptions.DebitCard,  'DebitCard');
    renderList(els.pmWallet, paymentOptions.Wallet,     'Wallet');
    renderList(els.pmUPI,    paymentOptions.UPI,        'UPI');
    renderList(els.pmNet,    paymentOptions.NetBanking, 'NetBanking');
    renderList(els.pmEMI,    paymentOptions.EMI,        'EMI');
  };

  // ===== Load payment options =====
  async function loadPaymentOptions() {
    console.log('[payment-options] fetching…', \`\${API}/payment-options\`);
    try {
      const r = await fetch(\`\${API}/payment-options\`, { cache: 'no-store' });
      const j = await r.json();
      console.log('[payment-options] response:', j);
      if (j && j.options) {
        paymentOptions = j.options;
      } else {
        // graceful fallback so you always see *something*
        paymentOptions = {
          CreditCard: ['Hdfc Bank','Icici Bank','Axis Bank','Kotak'],
          DebitCard:  ['Hdfc Bank','Icici Bank'],
          Wallet:     ['Amazon Pay','Paytm'],
          UPI:        ['PhonePe','Google Pay','Mobikwik'],
          NetBanking: ['Icici Bank','Hdfc Bank'],
          EMI:        ['Hdfc Bank EMI']
        };
        console.warn('[payment-options] backend empty, using fallback');
      }
      renderPaymentLists();
    } catch (e) {
      console.error('[payment-options] error:', e);
      toast('Could not load payment methods');
      // fallback
      paymentOptions = {
        UPI: ['Mobikwik'],
        CreditCard: [], DebitCard: [], Wallet: [], NetBanking: [], EMI: []
      };
      renderPaymentLists();
    }
  }

  // ===== Search =====
  function buildPayload() {
    const tripType = els.one.checked ? 'one-way' : 'round-trip';
    return {
      from: (els.from.value || 'BOM').toUpperCase(),
      to: (els.to.value || 'DEL').toUpperCase(),
      departureDate: els.dep.value,
      returnDate: tripType === 'round-trip' ? els.ret.value : '',
      passengers: Number(els.pax.value || 1),
      travelClass: (els.cabin.value || 'Economy').toLowerCase(),
      tripType,
      paymentMethods: selectedPayments.map(p => ({ bank: p.value, type: p.type }))
    };
  }

  function renderFlights(where, list) {
    if (!list || !list.length) { where.className='empty'; where.textContent='No flights'; return; }
    where.className=''; where.innerHTML='';
    list.forEach(f => {
      const card = document.createElement('div');
      card.className = 'flight-card';
      const portals = (f.portalPrices||[])
        .map(p => \`\${p.portal}: ₹\${new Intl.NumberFormat('en-IN').format(p.finalPrice)}\`).join(' • ');
      card.innerHTML = \`
        <div class="fc-title">\${f.airlineName} \${f.flightNumber}</div>
        <div class="fc-time">\${f.departure} → \${f.arrival} • Stops: \${f.stops||0}</div>
        <div class="fc-price">₹\${new Intl.NumberFormat('en-IN').format(Number(f.price||0))}</div>
        <div style="margin-top:6px;opacity:.9">▶ Portal prices (+₹${CARRIER_MARKUP} markup): \${portals || '—'}</div>
      \`;
      where.appendChild(card);
    });
  }

  async function doSearch() {
    const body = buildPayload();
    console.log('[search] POST', \`\${API}/search\`, body);
    try {
      const r = await fetch(\`\${API}/search\`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      const j = await r.json();
      console.log('[search] response', j);

      if (j.error && j.error.includes('timeout')) {
        toast('Backend timeout. Try again.');
        return;
      }
      if (j.meta && j.meta.reason) {
        toast(\`No flights found (\${j.meta.reason})\`);
      }
      renderFlights(els.outbound, j.outboundFlights || []);
      renderFlights(els.retlist, j.returnFlights || []);
    } catch (e) {
      console.error('[search] error', e);
      toast('Search failed. Check console.');
    }
  }

  // ===== Wire up =====
  (function init(){
    // default demo dates to avoid empty inputs
    const today = new Date();
    const pad = n => String(n).padStart(2,'0');
    const d1 = new Date(today); d1.setDate(d1.getDate()+3);
    const d2 = new Date(today); d2.setDate(d2.getDate()+5);
    const iso = d => \`\${d.getFullYear()}-\${pad(d.getMonth()+1)}-\${pad(d.getDate())}\`;
    if (!els.dep.value) els.dep.value = iso(d1);
    if (!els.ret.value) els.ret.value = iso(d2);

    els.payBtn.addEventListener('click', openModal);
    els.overlay.addEventListener('click', closeModal);
    els.pmDone.addEventListener('click', ()=>{ setBtnCount(); closeModal(); });
    els.pmClear.addEventListener('click', ()=>{ selectedPayments=[]; setBtnCount(); renderPaymentLists(); });

    els.tabs.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        showTab(btn.getAttribute('data-pm-tab'));
      });
    });

    els.one.addEventListener('change', ()=>{ if (els.one.checked) els.ret.closest('.field').style.opacity=.45; });
    els.rtrip.addEventListener('change', ()=>{ if (els.rtrip.checked) els.ret.closest('.field').style.opacity=1; });

    els.search.addEventListener('click', doSearch);

    loadPaymentOptions();
    setBtnCount();
    if (els.one.checked) els.ret.closest('.field').style.opacity=.45;

    console.log('[init] API base:', API);
  })();
  </script>
</body>
</html>
